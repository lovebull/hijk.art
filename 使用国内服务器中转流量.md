<div class="single-post-wrap entry-content"><blockquote><p>如有问题，欢迎到 <a href="https://hijk.club" target="_blank" rel="noopener noreferrer">网络跳越论坛</a> 或 tg群组<a href="https://t.me/hijk.club" target="_blank" rel="noopener nofollow">https://t.me/hijk.club</a> 交流</p></blockquote><p>经本人亲身实践，通过国内服务器转发科学上网流量不仅能有效避免墙的干扰，还有加速的作用。流量转发说白了就是流量从“<strong>国内&lt;–&gt;境外vps</strong>”变成了“<strong>国内&lt;–&gt;国内vps&lt;–&gt;境外vps</strong>”。看似多了一步，其实大有好处：国内服务器延迟很低，但出入境流量走高级线路，加起来一算总延迟实际上降低了；此外选择好的中转服务器，高峰时期也能跑满带宽，爽的一批。</p><p>中转属于<strong> 硬件加速 </strong>，代价是额外需要一台国内的服务器，优点是更稳定、能（比较）有效防止境外ip或端口被封。一些付费工具的高级线路也使用中转，以提供更优质的体验。</p><p>本教程详细介绍转发的过程，如有不明白的地方，欢迎留言讨论。</p><h2>配置国内服务器中转流量</h2><p>既然要通过国内服务器转发流量，首先必须要一台国内服务器。国内服务器的选择有很多，建议使用NAT VPS，年付几十到一两百，NAT VPS中转请参考：<a href="https://v2raytech.com/use-nat-vps-forward-traffic/" target="_blank" rel="noopener">使用NAT VPS中转加速</a>。也可以用阿里云、腾讯云这些大厂商的服务器，质量和服务都比较有保障。由于服务器仅做流量转发用，买最低配置的就可以，1核256m内存足够，看视频的话带宽买大点，也可以选择流量计费模式（不适合视频党）。</p><p>本文以CentOS 7/8系统为例介绍国内服务器中转配置，分别介绍firewalld流量转发和nginx流量转发两种方式。</p><h3>firewalld流量转发</h3><p><code class=" prettyprinted" style=""><span class="pln">firewalld</span></code>是CentOS7/8默认的防火墙前端软件，绝大多数主机商提供的镜像都已经安装。如果执行 <code class=" prettyprinted" style=""><span class="pln">firewall</span><span class="pun">-</span><span class="pln">cmd </span><span class="pun">--</span><span class="pln">state</span></code>的输出<strong>不是 running</strong>，请使用下面命令安装并开启<code class=" prettyprinted" style=""><span class="pln">firewalld</span></code>：</p><pre class=" prettyprinted" style=""><span class="pln">yum install </span><span class="pun">-</span><span class="pln">y firewalld
systemctl enable firewalld
systemctl start firewalld</span></pre><p>接着配置转发。假设你将国内服务器8080端口流量转发到国外vps的443端口，转发命令如下：</p><pre class=" prettyprinted" style=""><span></span><span class="pln"><span class="pln">echo </span></span><span class="str"><span class="str">'net.ipv4.ip_forward = 1'</span></span><span class="pln"><span class="pln"> </span></span><span class="pun"><span class="pun">&gt;&gt;</span></span><span class="pln"><span class="pln"> </span></span><span class="str"><span class="str">/etc/</span></span><span class="pln"><span class="pln">sysctl</span></span><span class="pun"><span class="pun">.</span></span><span class="pln"><span class="pln">conf</span></span><span class="pln">
sysctl </span><span class="pun">-</span><span class="pln">p
</span><span class="pln"><span class="pln">firewall</span></span><span class="pun"><span class="pun">-</span></span><span class="pln"><span class="pln">cmd </span></span><span class="pun"><span class="pun">--</span></span><span class="pln"><span class="pln">permanent </span></span><span class="pun"><span class="pun">--</span></span><span class="pln"><span class="kwd">add</span></span><span class="pun"><span class="pun">-</span></span><span class="pln"><span class="pln">masquerade
</span><span class="com"># 8080可以改成其他端口</span><span class="pln">
firewall</span><span class="pun"><span class="pun">-</span></span><span class="pln">cmd </span><span class="pun"><span class="pun">--</span></span><span class="pln">permanent </span><span class="pun"><span class="pun">--</span></span><span class="kwd">add</span><span class="pun"><span class="pun">-</span></span><span class="pln">port</span><span class="pun"><span class="pun">=</span></span><span class="lit"><span class="lit">8080</span></span><span class="pun"><span class="pun">/</span></span><span class="pln">tcp
firewall</span><span class="pun"><span class="pun">-</span></span><span class="pln">cmd </span><span class="pun"><span class="pun">--</span></span><span class="pln">permanent </span><span class="pun"><span class="pun">--</span></span><span class="kwd">add</span><span class="pun"><span class="pun">-</span></span><span class="pln">port</span><span class="pun"><span class="pun">=</span></span><span class="lit"><span class="lit">8080</span></span><span class="pun"><span class="pun">/</span><span class="pln">udp</span></span><span class="pln">
</span><span class="com"># 8080和上面保持一致，国外ip改成你国外vps的ip，443改成国外ss/ssr/v2ray等软件的端口</span><span class="pln">
firewall</span><span class="pun"><span class="pun">-</span></span><span class="pln">cmd </span><span class="pun"><span class="pun">--</span></span><span class="pln">permanent </span><span class="pun"><span class="pun">--</span></span><span class="kwd">add</span><span class="pun"><span class="pun">-</span></span><span class="pln">forward</span><span class="pun"><span class="pun">-</span></span><span class="pln">port</span><span class="pun"><span class="pun">=</span></span><span class="pln">port</span><span class="pun"><span class="pun">=</span></span><span class="lit"><span class="lit">8080</span></span><span class="pun"><span class="pun">:</span></span><span class="pln">proto</span><span class="pun"><span class="pun">=</span></span><span class="pln">tcp</span><span class="pun"><span class="pun">:</span></span><span class="pln">toaddr</span><span class="pun"><span class="pun">=</span></span><span class="lit"><span class="pun">国外</span><span class="pln">ip</span></span><span class="pun"><span class="pun">:</span></span><span class="pln">toport</span><span class="pun"><span class="pun">=</span></span><span class="lit"><span class="lit">443</span><span class="pln">
firewall</span><span class="pun"><span class="pun">-</span></span><span class="pln">cmd </span><span class="pun"><span class="pun">--</span></span><span class="pln">permanent </span><span class="pun"><span class="pun">--</span></span><span class="kwd">add</span><span class="pun"><span class="pun">-</span></span><span class="pln">forward</span><span class="pun"><span class="pun">-</span></span><span class="pln">port</span><span class="pun"><span class="pun">=</span></span><span class="pln">port</span><span class="pun"><span class="pun">=</span></span><span class="lit">8080</span><span class="pun"><span class="pun">:</span></span><span class="pln">proto</span><span class="pun"><span class="pun">=</span></span><span class="pln">udp</span><span class="pun"><span class="pun">:</span></span><span class="pln">toaddr</span><span class="pun"><span class="pun">=</span></span><span class="pun">国外</span><span class="pln">ip</span><span class="pun"></span><span class="pun"><span class="pun">:</span></span><span class="pln">toport</span><span class="pun"><span class="pun">=</span><span class="lit">443</span><span class="pln">
firewall</span><span class="pun">-</span><span class="pln">cmd </span><span class="pun">--</span><span class="pln">reload</span></span></span></span></pre><p>运行上述命令后，打开ss/ssr/v2ray等客户端软件，把ip和端口 <strong>改成国内vps的ip和端口号</strong>，应该同样能正常上外网。</p><blockquote><p>如果中转trojan流量，记得把客户端配置文件中的<strong>两个verify选项设置为false</strong>!</p></blockquote><p><code class=" prettyprinted" style=""><span class="pln">firewalld</span></code>转发的好处是<strong>效率高</strong>，直接在内核执行。</p><h3>Nginx流量转发</h3><p>Nginx是非常强大的四层、七层反向代理软件，功能强大，在互联网上广泛应用。本节介绍Nginx转发配置。</p><p>1. 首先安装nginx：<code class=" prettyprinted" style=""><span class="pln">yum install </span><span class="pun">-</span><span class="pln">y epel</span><span class="pun">-</span><span class="pln">release </span><span class="pun">&amp;&amp;</span><span class="pln"> yum install </span><span class="pun">-</span><span class="pln">y nginx</span></code>；</p><p>2. 配置nginx：编辑/etc/nginx/nginx.conf文件，加入转发配置：</p><pre class=" prettyprinted" style=""><code class=" prettyprinted" style=""><span class="com"><span class="com"># For more information on configuration, see:</span></span><span class="pln"><span class="pln">
</span></span><span class="com"><span class="com">#   * Official English Documentation: http://nginx.org/en/docs/</span></span><span class="pln"><span class="pln">
</span></span><span class="com"><span class="com">#   * Official Russian Documentation: http://nginx.org/ru/docs/</span></span><span class="pln"><span class="pln">

user nginx</span></span><span class="pun"><span class="pun">;</span></span><span class="pln"><span class="pln">
worker_processes </span></span><span class="kwd"><span class="kwd">auto</span></span><span class="pun"><span class="pun">;</span></span><span class="pln"><span class="pln">
error_log </span></span><span class="pun"><span class="pun">/</span></span><span class="kwd"><span class="kwd">var</span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">log</span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">nginx</span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">error</span></span><span class="pun"><span class="pun">.</span></span><span class="pln"><span class="pln">log</span></span><span class="pun"><span class="pun">;</span></span><span class="pln"><span class="pln">
pid </span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">run</span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">nginx</span></span><span class="pun"><span class="pun">.</span></span><span class="pln"><span class="pln">pid</span></span><span class="pun"><span class="pun">;</span></span><span class="pln"><span class="pln">

</span></span><span class="com"><span class="com"># Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.</span></span><span class="pln"><span class="pln">
include </span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">usr</span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">share</span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">nginx</span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">modules</span></span><span class="com"><span class="com">/*.conf;

events {
    worker_connections 1024;
}

# 增加的配置
stream {
    server {
        listen 端口号;  # 1-65535的任意一个数字，无需与境外服务器的端口号相同
        proxy_pass 境外ip:境外端口号; # 用境外ip和端口号替换
    }
}
# 转发配置结束

http {
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile            on;
    tcp_nopush          on;
    tcp_nodelay         on;
    keepalive_timeout   65;
    types_hash_max_size 2048;
    ....
}</span></span></code></pre><p>配置中增加了以 <strong>stream</strong> 开头的那一段，其他都是自带的。将上面代码中的ip和端口换成你的，然后保存文件。用<code class=" prettyprinted" style=""><span class="pln">nginx </span><span class="pun">-</span><span class="pln">t</span></code>检查配置有没有错误，有如下输出说明配置正确：</p><pre class=" prettyprinted" style=""><code class=" prettyprinted" style=""><span class="pln"><span class="pln">nginx</span></span><span class="pun"><span class="pun">:</span></span><span class="pln"><span class="pln"> the configuration file </span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">etc</span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">nginx</span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">nginx</span></span><span class="pun"><span class="pun">.</span></span><span class="pln"><span class="pln">conf syntax </span></span><span class="kwd"><span class="kwd">is</span></span><span class="pln"><span class="pln"> ok
nginx</span></span><span class="pun"><span class="pun">:</span></span><span class="pln"><span class="pln"> configuration file </span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">etc</span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">nginx</span></span><span class="pun"><span class="pun">/</span></span><span class="pln"><span class="pln">nginx</span></span><span class="pun"><span class="pun">.</span></span><span class="pln"><span class="pln">conf test </span></span><span class="kwd"><span class="kwd">is</span></span><span class="pln"><span class="pln"> successful</span></span></code></pre><p>如果有问题，请按照提示更改。</p><p>3. 改好后设置开机启动并启动nginx：<code class=" prettyprinted" style=""><span class="pln">systemctl enable nginx </span><span class="pun">&amp;&amp;</span><span class="pln"> systemctl start nginx</span></code>。接着用<code class=" prettyprinted" style=""><span class="pln">ss </span><span class="pun">-</span><span class="pln">ntlp</span><span class="pun">|</span><span class="pln"> grep </span><span class="pun">-</span><span class="pln">i nginx</span></code>查看软件是否正常运行。如果输出为空，可能的问题是端口号冲突，改成其他端口号试试；或者是selinux的限制，用下面命令禁用selinux：</p><p><code class=" prettyprinted" style=""><span class="pln">sed </span><span class="pun">-</span><span class="pln">i </span><span class="str">'s/SELINUX=enforcing/SELINUX=permissive/g'</span><span class="pln"> </span><span class="pun">/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">selinux</span><span class="pun">/</span><span class="pln">config</span><br><span class="pln"> setenforce </span><span class="lit">0</span></code></p><p>4. 如果服务器启动了防火墙，放行nginx监听的端口。怎么看防火墙是否开启呢？输入<code class=" prettyprinted" style=""><span class="pln">firewall</span><span class="pun">-</span><span class="pln">cmd </span><span class="pun">--</span><span class="pln">state</span></code>，输出是”running”表示防火墙正在运行。用如下命令把端口放行：</p><pre class=" prettyprinted" style=""><code class=" prettyprinted" style=""><span class="pln"><span class="pln">firewall</span></span><span class="pun"><span class="pun">-</span></span><span class="pln"><span class="pln">cmd </span></span><span class="pun"><span class="pun">--</span></span><span class="pln"><span class="pln">permanent </span></span><span class="pun"><span class="pun">--</span></span><span class="kwd"><span class="kwd">add</span></span><span class="pun"><span class="pun">-</span></span><span class="pln"><span class="pln">port</span></span><span class="pun"><span class="pun">=</span></span><span class="pln"><span class="pln">nginx</span></span><span class="pun"><span class="pun">中配置的端口号/</span></span><span class="pln"><span class="pln">tcp
fireawll</span></span><span class="pun"><span class="pun">-</span></span><span class="pln"><span class="pln">cmd </span></span><span class="pun"><span class="pun">--</span></span><span class="pln"><span class="pln">reload</span></span></code></pre><p>5. 如果服务器厂商上层还有防火墙/安全组(阿里云/腾讯云等购买的vps)，请记得到控制台放行相应端口。</p><p>完成上述操作后，搭建手机、电脑上的ss/ssr/v2ray等客户端，把ip和端口 <strong>改成国内vps的ip和端口号</strong>，应该同样能正常上外网。</p><blockquote><p>如果中转trojan流量，记得把客户端配置文件中的<strong>两个verify选项设置为false</strong>!</p></blockquote><p>Nginx效率不如firewalld/iptables，但是配置更灵活，使用上更便利。</p><h2>配置境外服务器</h2><p>原则上只要境外服务器没被墙或者端口没有被封，配置好国内服务器就直接能用且有加速效果。对境外服务器做配置，<strong>主要是为了降低墙的干扰，减少ip被墙的机率</strong>。如果你不清楚下面的操作，请不要做这一步！</p><p>配置境外服务器的重点：<strong>除ssh的22、正常服务的端口(例如网站)，其他端口只允许国内服务器连接</strong>。操作如下：</p><p>1. 启动系统防火墙：<code class=" prettyprinted" style=""><span class="pln">systemctl enable firewalld </span><span class="pun">&amp;&amp;</span><span class="pln"> systemctl start firewalld</span></code></p><p>2. 删除之前放行过的ss/ssr/v2ray等端口（如果配置过）：<code class=" prettyprinted" style=""><span class="pln">firewall</span><span class="pun">-</span><span class="pln">cmd </span><span class="pun">--</span><span class="pln">permanent </span><span class="pun">--</span><span class="kwd">remove</span><span class="pun">-</span><span class="pln">port</span><span class="pun">=端口/</span><span class="pln">tcp</span></code></p><p>3. 仅允许国内ip连接该服务器：</p><pre class=" prettyprinted" style=""><code class=" prettyprinted" style=""><span class="pln"><span class="pln">firewall</span></span><span class="pun"><span class="pun">-</span></span><span class="pln"><span class="pln">cmd </span></span><span class="pun"><span class="pun">--</span></span><span class="pln"><span class="pln">permanent </span></span><span class="pun"><span class="pun">--</span></span><span class="kwd"><span class="kwd">add</span></span><span class="pun"><span class="pun">-</span></span><span class="pln"><span class="pln">source</span></span><span class="pun"><span class="pun">=国内</span></span><span class="pln"><span class="pln">ip</span></span><span class="pun"><span class="pun">/</span></span><span class="lit"><span class="lit">32</span></span><span class="pln"><span class="pln">
fireawll</span></span><span class="pun"><span class="pun">-</span></span><span class="pln"><span class="pln">cmd </span></span><span class="pun"><span class="pun">--</span></span><span class="pln"><span class="pln">reload</span></span></code></pre><p>经过如上配置后，gfw探测你的vps，除了ssh、网站等常用端口，ss/ssr/v2ray的端口直接无法连接，被墙的概率自然就降低了。</p><h2>其他</h2><p>一些注意事项：</p><ol><li>nginx支持转发流量到多个服务器实现负载均衡，配置上需要用到<strong>upstream</strong>块，请参考文档或留言；</li><li>如果用的是<strong>iptables</strong>，把firewalld命令替换成iptables命令执行就可以</li><li>如果动手能力强，最好把境外vps配置得像一个业务机器，例如一个有各种爬虫访问的网站，基本上就稳如狗了（本人用的就是这种）；</li><li>配置客户端时，ip和端口填国内服务器的，其他信息（密码、加密方式等）和国外服务器保持一致；</li><li>NAT VPS需要端口映射，因此客户端配置的ip和端口应该是NAT VPS映射获取到的公网ip和端口号。</li></ol><p>&nbsp;</p></div>